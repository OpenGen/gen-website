<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS --> 
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/css/styles.css">

    <!-- MathJax -->
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <title>Proposals with PyTorch in Gen</title>
  </head>
  <body>
    
    <header class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar">
  <a class="navbar-brand mr-0 mr-md-2" href="/" aria-label="Gen">
<svg version="1.1" width="36" height="36" viewBox="0.0 0.0 433.7244094488189 432.76640419947506" fill="none" stroke="none" stroke-linecap="square" stroke-miterlimit="10" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"><clipPath id="p.0"><path d="m0 0l433.7244 0l0 432.76642l-433.7244 0l0 -432.76642z" clip-rule="nonzero"/></clipPath><g clip-path="url(#p.0)"><path fill="#000000" fill-opacity="0.0" d="m0 0l433.7244 0l0 432.76642l-433.7244 0z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m526.3617 215.97453l0 0c0 -112.37038 91.09418 -203.46457 203.4646 -203.46457l0 0c53.96216 0 105.71411 21.436382 143.87115 59.593395c38.156982 38.157005 59.593384 89.90901 59.593384 143.87117l0 0c0 112.37038 -91.09418 203.46455 -203.46454 203.46455l0 0c-112.37042 0 -203.4646 -91.09418 -203.4646 -203.46455z" fill-rule="evenodd"/><path stroke="#ffffff" stroke-width="16.0" stroke-linejoin="round" stroke-linecap="butt" d="m526.3617 215.97453l0 0c0 -112.37038 91.09418 -203.46457 203.4646 -203.46457l0 0c53.96216 0 105.71411 21.436382 143.87115 59.593395c38.156982 38.157005 59.593384 89.90901 59.593384 143.87117l0 0c0 112.37038 -91.09418 203.46455 -203.46454 203.46455l0 0c-112.37042 0 -203.4646 -91.09418 -203.4646 -203.46455z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m95.40751 8.810548l290.11023 0l0 288.18896l-290.11023 0z" fill-rule="evenodd"/><path fill="#ffffff" d="m308.04813 300.89618q-12.859375 15.421875 -36.375 23.921875q-23.5 8.484375 -52.09375 8.484375q-30.03125 0 -52.671875 -13.09375q-22.625 -13.109375 -34.9375 -38.046875q-12.312492 -24.9375 -12.624992 -58.625l0 -15.71875q0 -34.640625 11.671867 -59.96875q11.671875 -25.34375 33.671875 -38.765625q22.0 -13.421875 51.546875 -13.421875q41.140625 0 64.328125 19.625q23.203125 19.609375 27.484375 57.109375l-46.375 0q-3.171875 -19.859375 -14.0625 -29.0625q-10.875 -9.21875 -29.9375 -9.21875q-24.3125 0 -37.015625 18.265625q-12.703125 18.265625 -12.875 54.328125l0 14.765625q0 36.375 13.8125 54.96875q13.828125 18.578125 40.515625 18.578125q26.859375 0 38.296875 -11.4375l0 -39.875l-43.375 0l0 -35.09375l91.015625 0l0 92.28125z" fill-rule="nonzero"/><path fill="#000000" fill-opacity="0.0" d="m20.661194 84.271866l0 0c0 -36.022438 29.201962 -65.224396 65.2244 -65.224396l260.8898 0l0 0c17.298584 0 33.88864 6.8718376 46.120605 19.103786c12.231934 12.231945 19.10379 28.82203 19.10379 46.120613l0 260.88977c0 36.02243 -29.201965 65.224396 -65.224396 65.224396l-260.8898 0c-36.02244 0 -65.2244 -29.201965 -65.2244 -65.224396z" fill-rule="evenodd"/><path stroke="#ffffff" stroke-width="24.0" stroke-linejoin="round" stroke-linecap="butt" d="m20.661194 84.271866l0 0c0 -36.022438 29.201962 -65.224396 65.2244 -65.224396l260.8898 0l0 0c17.298584 0 33.88864 6.8718376 46.120605 19.103786c12.231934 12.231945 19.10379 28.82203 19.10379 46.120613l0 260.88977c0 36.02243 -29.201965 65.224396 -65.224396 65.224396l-260.8898 0c-36.02244 0 -65.2244 -29.201965 -65.2244 -65.224396z" fill-rule="evenodd"/></g></svg>
</a>
  <div class="navbar-nav-scroll">
    <ul class="navbar-nav bd-navbar-nav flex-row">
    
      <li class="nav-item">
        <a class="nav-link " href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-link " href="https://www.gen.dev/dev/">Documentation</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-link " href="/tutorials/">Tutorials</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-link " href="https://github.com/probcomp/Gen.jl">Source</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-link " href="/ecosystem/">Ecosystem</a>
      </li>
    
    </ul>
  </div>

</header>



<main role="main">
    <br/>
<div class="container">
<h1 id="tutorial-data-driven-proposals-with-pytorch">Tutorial: Data-Driven Proposals with PyTorch</h1>

<p>This tutorial is a short extension to <a href="../Data-Driven%20Proposals%20in%20Gen.jl">Data-Driven Proposals in Gen</a>, 
which shows how to use PyTorch for easier specification of the proposal.</p>

<p>For this tutorial, you’ll need to ensure that you have PyCall installed, and pointing to a Python that has Torch installed.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">using</span> <span class="n">Gen</span><span class="x">,</span> <span class="n">GenPyTorch</span><span class="x">,</span> <span class="n">PyCall</span>
</code></pre></div></div>

<p>We recreate the relevant parts of the model from the Data-Driven Proposals in Gen tutorial:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">include</span><span class="x">(</span><span class="s">"../../inverse-planning/geometric_primitives.jl"</span><span class="x">);</span>
<span class="n">include</span><span class="x">(</span><span class="s">"../../inverse-planning/scene.jl"</span><span class="x">);</span>
<span class="n">include</span><span class="x">(</span><span class="s">"../../inverse-planning/viz.jl"</span><span class="x">)</span>
<span class="n">include</span><span class="x">(</span><span class="s">"../../inverse-planning/planning.jl"</span><span class="x">);</span>

<span class="n">scene</span> <span class="o">=</span> <span class="n">Scene</span><span class="x">(</span><span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="x">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="x">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="x">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="x">)</span>
<span class="n">add_obstacle!</span><span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">make_square</span><span class="x">(</span><span class="n">Point</span><span class="x">(</span><span class="mf">0.30</span><span class="x">,</span> <span class="mf">0.20</span><span class="x">),</span> <span class="mf">0.1</span><span class="x">))</span>
<span class="n">add_obstacle!</span><span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">make_square</span><span class="x">(</span><span class="n">Point</span><span class="x">(</span><span class="mf">0.83</span><span class="x">,</span> <span class="mf">0.80</span><span class="x">),</span> <span class="mf">0.1</span><span class="x">))</span>
<span class="n">add_obstacle!</span><span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">make_square</span><span class="x">(</span><span class="n">Point</span><span class="x">(</span><span class="mf">0.80</span><span class="x">,</span> <span class="mf">0.40</span><span class="x">),</span> <span class="mf">0.1</span><span class="x">))</span>
<span class="n">horizontal</span> <span class="o">=</span> <span class="n">false</span>
<span class="n">vertical</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">wall_thickness</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">add_obstacle!</span><span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">make_line</span><span class="x">(</span><span class="n">horizontal</span><span class="x">,</span> <span class="n">Point</span><span class="x">(</span><span class="mf">0.20</span><span class="x">,</span> <span class="mf">0.40</span><span class="x">),</span> <span class="mf">0.40</span><span class="x">,</span> <span class="n">wall_thickness</span><span class="x">))</span>
<span class="n">add_obstacle!</span><span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">make_line</span><span class="x">(</span><span class="n">vertical</span><span class="x">,</span> <span class="n">Point</span><span class="x">(</span><span class="mf">0.60</span><span class="x">,</span> <span class="mf">0.40</span><span class="x">),</span> <span class="mf">0.40</span><span class="x">,</span> <span class="n">wall_thickness</span><span class="x">))</span>
<span class="n">add_obstacle!</span><span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">make_line</span><span class="x">(</span><span class="n">horizontal</span><span class="x">,</span> <span class="n">Point</span><span class="x">(</span><span class="mf">0.60</span> <span class="o">-</span> <span class="mf">0.15</span><span class="x">,</span> <span class="mf">0.80</span><span class="x">),</span> <span class="mf">0.15</span> <span class="o">+</span> <span class="n">wall_thickness</span><span class="x">,</span> <span class="n">wall_thickness</span><span class="x">))</span>
<span class="n">add_obstacle!</span><span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">make_line</span><span class="x">(</span><span class="n">horizontal</span><span class="x">,</span> <span class="n">Point</span><span class="x">(</span><span class="mf">0.20</span><span class="x">,</span> <span class="mf">0.80</span><span class="x">),</span> <span class="mf">0.15</span><span class="x">,</span> <span class="n">wall_thickness</span><span class="x">))</span>
<span class="n">add_obstacle!</span><span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">make_line</span><span class="x">(</span><span class="n">vertical</span><span class="x">,</span> <span class="n">Point</span><span class="x">(</span><span class="mf">0.20</span><span class="x">,</span> <span class="mf">0.40</span><span class="x">),</span> <span class="mf">0.40</span><span class="x">,</span> <span class="n">wall_thickness</span><span class="x">));</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">Point</span><span class="x">(</span><span class="mf">0.1</span><span class="x">,</span> <span class="mf">0.1</span><span class="x">)</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">num_ticks</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">planner_params</span> <span class="o">=</span> <span class="n">PlannerParams</span><span class="x">(</span><span class="n">rrt_iters</span><span class="o">=</span><span class="mi">600</span><span class="x">,</span> <span class="n">rrt_dt</span><span class="o">=</span><span class="mf">0.05</span><span class="x">,</span>
                               <span class="n">refine_iters</span><span class="o">=</span><span class="mi">3500</span><span class="x">,</span> <span class="n">refine_std</span><span class="o">=</span><span class="mf">1.</span><span class="x">);</span>

<span class="nd">@gen</span> <span class="k">function</span><span class="nf"> agent_model</span><span class="x">(</span>
        <span class="n">scene</span><span class="o">::</span><span class="n">Scene</span><span class="x">,</span> <span class="n">dt</span><span class="o">::</span><span class="kt">Float64</span><span class="x">,</span> <span class="n">num_ticks</span><span class="o">::</span><span class="kt">Int</span><span class="x">,</span> 
        <span class="n">planner_params</span><span class="o">::</span><span class="n">PlannerParams</span><span class="x">)</span>

    <span class="c"># sample the start point of the agent from the prior</span>
    <span class="n">start_x</span> <span class="o">~</span> <span class="n">uniform</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mi">1</span><span class="x">)</span>
    <span class="n">start_y</span> <span class="o">~</span> <span class="n">uniform</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mi">1</span><span class="x">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">Point</span><span class="x">(</span><span class="n">start_x</span><span class="x">,</span> <span class="n">start_y</span><span class="x">)</span>

    <span class="c"># sample the destination point of the agent from the prior</span>
    <span class="n">dest_x</span> <span class="o">~</span> <span class="n">uniform</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mi">1</span><span class="x">)</span>
    <span class="n">dest_y</span> <span class="o">~</span> <span class="n">uniform</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mi">1</span><span class="x">)</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">Point</span><span class="x">(</span><span class="n">dest_x</span><span class="x">,</span> <span class="n">dest_y</span><span class="x">)</span>

    <span class="c"># plan a path that avoids obstacles in the scene</span>
    <span class="n">maybe_path</span> <span class="o">=</span> <span class="n">plan_path</span><span class="x">(</span><span class="n">start</span><span class="x">,</span> <span class="n">dest</span><span class="x">,</span> <span class="n">scene</span><span class="x">,</span> <span class="n">planner_params</span><span class="x">)</span>
    <span class="n">planning_failed</span> <span class="o">=</span> <span class="n">maybe_path</span> <span class="o">===</span> <span class="n">nothing</span>
    
    <span class="c"># sample the speed from the prior</span>
    <span class="n">speed</span> <span class="o">~</span> <span class="n">uniform</span><span class="x">(</span><span class="mf">0.3</span><span class="x">,</span> <span class="mi">1</span><span class="x">)</span>

    <span class="k">if</span> <span class="n">planning_failed</span>   
        <span class="c"># path planning failed; assume agent stays at start location indefinitely</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="n">fill</span><span class="x">(</span><span class="n">start</span><span class="x">,</span> <span class="n">num_ticks</span><span class="x">)</span>
    <span class="k">else</span>   
        <span class="c"># path planning succeeded; move along the path at constant speed</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="n">walk_path</span><span class="x">(</span><span class="n">maybe_path</span><span class="x">,</span> <span class="n">speed</span><span class="x">,</span> <span class="n">dt</span><span class="x">,</span> <span class="n">num_ticks</span><span class="x">)</span>
    <span class="k">end</span>

    <span class="c"># generate noisy measurements of the agent's location at each time point</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="k">for</span> <span class="x">(</span><span class="n">i</span><span class="x">,</span> <span class="n">point</span><span class="x">)</span> <span class="k">in</span> <span class="n">enumerate</span><span class="x">(</span><span class="n">locations</span><span class="x">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="x">{:</span><span class="n">meas</span> <span class="o">=&gt;</span> <span class="x">(</span><span class="n">i</span><span class="x">,</span> <span class="x">:</span><span class="n">x</span><span class="x">)}</span> <span class="o">~</span> <span class="n">normal</span><span class="x">(</span><span class="n">point</span><span class="o">.</span><span class="n">x</span><span class="x">,</span> <span class="n">noise</span><span class="x">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="x">{:</span><span class="n">meas</span> <span class="o">=&gt;</span> <span class="x">(</span><span class="n">i</span><span class="x">,</span> <span class="x">:</span><span class="n">y</span><span class="x">)}</span> <span class="o">~</span> <span class="n">normal</span><span class="x">(</span><span class="n">point</span><span class="o">.</span><span class="n">y</span><span class="x">,</span> <span class="n">noise</span><span class="x">)</span>
    <span class="k">end</span>

    <span class="k">return</span> <span class="x">(</span><span class="n">planning_failed</span><span class="x">,</span> <span class="n">maybe_path</span><span class="x">)</span>
<span class="k">end</span><span class="x">;</span>

<span class="n">measurements</span> <span class="o">=</span> <span class="x">[</span>
    <span class="n">Point</span><span class="x">(</span><span class="mf">0.0980245</span><span class="x">,</span> <span class="mf">0.104775</span><span class="x">),</span>
    <span class="n">Point</span><span class="x">(</span><span class="mf">0.113734</span><span class="x">,</span> <span class="mf">0.150773</span><span class="x">),</span>
    <span class="n">Point</span><span class="x">(</span><span class="mf">0.100412</span><span class="x">,</span> <span class="mf">0.195499</span><span class="x">),</span>
    <span class="n">Point</span><span class="x">(</span><span class="mf">0.114794</span><span class="x">,</span> <span class="mf">0.237386</span><span class="x">),</span>
    <span class="n">Point</span><span class="x">(</span><span class="mf">0.0957668</span><span class="x">,</span> <span class="mf">0.277711</span><span class="x">),</span>
    <span class="n">Point</span><span class="x">(</span><span class="mf">0.140181</span><span class="x">,</span> <span class="mf">0.31304</span><span class="x">),</span>
    <span class="n">Point</span><span class="x">(</span><span class="mf">0.124384</span><span class="x">,</span> <span class="mf">0.356242</span><span class="x">),</span>
    <span class="n">Point</span><span class="x">(</span><span class="mf">0.122272</span><span class="x">,</span> <span class="mf">0.414463</span><span class="x">),</span>
    <span class="n">Point</span><span class="x">(</span><span class="mf">0.124597</span><span class="x">,</span> <span class="mf">0.462056</span><span class="x">),</span>
    <span class="n">Point</span><span class="x">(</span><span class="mf">0.126227</span><span class="x">,</span> <span class="mf">0.498338</span><span class="x">)];</span>
</code></pre></div></div>

<p>PyCall allows us to import Python libraries directly into our Julia code:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">torch</span> <span class="o">=</span> <span class="n">pyimport</span><span class="x">(</span><span class="s">"torch"</span><span class="x">)</span>
<span class="n">nn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PyObject &lt;module 'torch.nn.functional' from '/Users/alexlew/gen-quickstart/tutorials/pytorch/venv/lib/python3.9/site-packages/torch/nn/functional.py'&gt;
</code></pre></div></div>

<p>It also provides the <code class="highlighter-rouge">@pydef</code> macro, which we can use to define Python classes using Julia code.
In PyTorch, new neural network architectures are defined as subclasses
of the <code class="highlighter-rouge">nn.Module</code> class. We create our own neural network class here, 
called <code class="highlighter-rouge">NeuralProposal</code>.</p>

<p>Every module needs to define two methods: <code class="highlighter-rouge">__init__</code> and <code class="highlighter-rouge">forward</code>.</p>

<p>In <code class="highlighter-rouge">__init__</code>, we create any layers we will use later. The expression 
<code class="highlighter-rouge">nn.Linear(input_dim, output_dim)</code> creates a fully-connected layer mapping
a given number of input dimensions to a given number of output dimensions.
Here, we construct three such layers: <code class="highlighter-rouge">fc1</code> maps our four inputs to 50 hidden
units, <code class="highlighter-rouge">fc2</code> transforms the 50 hidden units, and <code class="highlighter-rouge">fc3</code> maps the 50 hidden
units to 5 output neurons, which will later be normalized into the 5
bin probabilities for <code class="highlighter-rouge">dest_x</code> or <code class="highlighter-rouge">dest_y</code>. (PyTorch also comes with helpers
for constructing more complex layers, including convolutional layers and RNN
cells, but we do not cover that here.)</p>

<p>The <code class="highlighter-rouge">forward</code> function actually implements the neural network’s computation,
making use of any layers created in <code class="highlighter-rouge">__init__</code>. Here, we use <code class="highlighter-rouge">ReLU</code> activation
functions, instead of the <code class="highlighter-rouge">tanh</code>-based activation used in the previous section.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@pydef</span> <span class="n">mutable</span> <span class="n">struct</span> <span class="n">NeuralProposal</span> <span class="o">&lt;:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span>
    <span class="k">function</span><span class="nf"> __init__</span><span class="x">(</span><span class="n">self</span><span class="x">,</span> <span class="n">num_in</span><span class="x">)</span>
        <span class="c"># Note the use of pybuiltin(:super): built in Python functions</span>
        <span class="c"># like `super` or `str` or `slice` are all accessed using</span>
        <span class="c"># `pybuiltin`.</span>
        <span class="n">pybuiltin</span><span class="x">(:</span><span class="k">super</span><span class="x">)(</span><span class="n">NeuralProposal</span><span class="x">,</span> <span class="n">self</span><span class="x">)</span><span class="o">.</span><span class="n">__init__</span><span class="x">()</span>
        <span class="n">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="x">(</span><span class="n">num_in</span><span class="x">,</span> <span class="mi">50</span><span class="x">)</span>
        <span class="n">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="x">(</span><span class="mi">50</span><span class="x">,</span> <span class="mi">50</span><span class="x">)</span>
        <span class="n">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="x">(</span><span class="mi">50</span><span class="x">,</span> <span class="mi">5</span><span class="x">)</span>
    <span class="k">end</span>

    <span class="k">function</span><span class="nf"> forward</span><span class="x">(</span><span class="n">self</span><span class="x">,</span> <span class="n">x</span><span class="x">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="x">(</span><span class="n">self</span><span class="o">.</span><span class="n">fc1</span><span class="x">(</span><span class="n">x</span><span class="x">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="x">(</span><span class="n">self</span><span class="o">.</span><span class="n">fc2</span><span class="x">(</span><span class="n">x</span><span class="x">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="o">.</span><span class="n">fc3</span><span class="x">(</span><span class="n">x</span><span class="x">)</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PyObject &lt;class 'NeuralProposal'&gt;
</code></pre></div></div>

<p>Once we’ve defined a <code class="highlighter-rouge">nn.Module</code>, we can create a generative function out of it
using the <code class="highlighter-rouge">TorchGenerativeFunction</code> constructor. The first argument is an
instantiated Torch model, in our case, <code class="highlighter-rouge">NeuralProposal(4)</code>. Here, <code class="highlighter-rouge">4</code> is the
value we are passing into <code class="highlighter-rouge">NeuralProposal</code>’s <code class="highlighter-rouge">__init__</code> method, which expects
us to provide <code class="highlighter-rouge">num_in</code>, the number of input units. The second argument to
<code class="highlighter-rouge">TorchGenerativeFunction</code> is a list of <code class="highlighter-rouge">TorchArg</code> objects, describing the 
arguments to the <code class="highlighter-rouge">forward</code> function. We have only one argument, <code class="highlighter-rouge">x</code>, so we pass
in a list of one element. A <code class="highlighter-rouge">TorchArg</code> object specifies the argument’s <code class="highlighter-rouge">dtype</code> 
(<code class="highlighter-rouge">torch.float</code> in this case, for 32-bit floating-point numbers), and a Boolean
for whether gradients should flow through this argument (almost always <code class="highlighter-rouge">true</code>, unless
the argument is some discrete value, e.g., a Boolean flag). Finally, we pass in
the number of output tensors to expect from calling <code class="highlighter-rouge">forward</code> – in this case, just one.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x_nn</span> <span class="o">=</span> <span class="n">TorchGenerativeFunction</span><span class="x">(</span><span class="n">NeuralProposal</span><span class="x">(</span><span class="mi">4</span><span class="x">),</span> <span class="x">[</span><span class="n">TorchArg</span><span class="x">(</span><span class="n">true</span><span class="x">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="x">)],</span> <span class="mi">1</span><span class="x">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">x_nn</code> can now be called on inputs:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x_nn</span><span class="x">([</span><span class="mf">0.0</span><span class="x">,</span> <span class="mf">0.0</span><span class="x">,</span> <span class="mf">0.0</span><span class="x">,</span> <span class="mf">0.0</span><span class="x">])</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5-element Vector{Float64}:
 -0.07767701894044876
  0.006771232932806015
 -0.06922771036624908
 -0.11070195585489273
  0.028574829921126366
</code></pre></div></div>

<p>To turn these into bin probabilities, we’ll use <code class="highlighter-rouge">softmax</code>:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">softmax</span><span class="x">(</span><span class="n">logits</span><span class="x">)</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="x">(</span><span class="n">logits</span> <span class="o">.-</span> <span class="n">logsumexp</span><span class="x">(</span><span class="n">logits</span><span class="x">))</span>

<span class="n">softmax</span><span class="x">(</span><span class="n">x_nn</span><span class="x">([</span><span class="mf">0.0</span><span class="x">,</span> <span class="mf">0.0</span><span class="x">,</span> <span class="mf">0.0</span><span class="x">,</span> <span class="mf">0.0</span><span class="x">]))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5-element Vector{Float64}:
 0.19319124522982853
 0.21021458830983716
 0.19483049317822299
 0.18691531798546976
 0.2148483552966415
</code></pre></div></div>

<p>Our proposal in this section will actually use <em>two</em> neural networks: after 
generating a <code class="highlighter-rouge">dest_x</code> using the probabilities from <code class="highlighter-rouge">x_nn</code>, it will generate
a <code class="highlighter-rouge">dest_y</code> from a second network, <code class="highlighter-rouge">y_nn</code>. But <code class="highlighter-rouge">y_nn</code> will take an additional
argument: the sampled <code class="highlighter-rouge">dest_x</code> value. This way, in theory, the <code class="highlighter-rouge">y</code> neural network
can propose different <code class="highlighter-rouge">dest_y</code> values depending on the sampled <code class="highlighter-rouge">x</code>.</p>

<p>To this end, we create a <code class="highlighter-rouge">y_nn</code> that accepts 5 inputs, rather than 4. Note that
every time we call <code class="highlighter-rouge">NeuralProposal(...)</code>, it is calling <code class="highlighter-rouge">__init__</code> to generate a
fresh set of layers and their parameters; so the parameters are not shared between
<code class="highlighter-rouge">x_nn</code> and <code class="highlighter-rouge">y_nn</code>.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y_nn</span> <span class="o">=</span> <span class="n">TorchGenerativeFunction</span><span class="x">(</span><span class="n">NeuralProposal</span><span class="x">(</span><span class="mi">5</span><span class="x">),</span> <span class="x">[</span><span class="n">TorchArg</span><span class="x">(</span><span class="n">true</span><span class="x">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="x">)],</span> <span class="mi">1</span><span class="x">);</span>
</code></pre></div></div>

<p>We are now ready to write our custom proposal, which calls each neural 
network to generate probabilities, then samples using <code class="highlighter-rouge">piecewise_uniform</code>.
Note that because the neural networks are generative functions, we call them
using <code class="highlighter-rouge">~</code> — even though they make no random choices. This is important for
Gen’s gradient-based optimization features to work properly.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scale_coord</span><span class="x">(</span><span class="n">coord</span><span class="x">,</span> <span class="n">min</span><span class="x">,</span> <span class="n">max</span><span class="x">)</span> <span class="o">=</span> <span class="x">(</span><span class="n">coord</span> <span class="o">/</span> <span class="x">(</span><span class="n">max</span> <span class="o">-</span> <span class="n">min</span><span class="x">))</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">num_x_bins</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">num_y_bins</span> <span class="o">=</span> <span class="mi">5</span><span class="x">;</span>

<span class="nd">@gen</span> <span class="k">function</span><span class="nf"> custom_dest_proposal_torch</span><span class="x">(</span><span class="n">measurements</span><span class="o">::</span><span class="n">Vector</span><span class="x">{</span><span class="n">Point</span><span class="x">},</span> <span class="n">scene</span><span class="o">::</span><span class="n">Scene</span><span class="x">)</span>
    <span class="c"># scale inputs to be in the range [-0.5, 0.5]</span>
    <span class="n">x_first</span> <span class="o">=</span> <span class="n">scale_coord</span><span class="x">(</span><span class="n">measurements</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span><span class="o">.</span><span class="n">x</span><span class="x">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">xmin</span><span class="x">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">xmax</span><span class="x">)</span>
    <span class="n">x_last</span> <span class="o">=</span> <span class="n">scale_coord</span><span class="x">(</span><span class="n">measurements</span><span class="x">[</span><span class="k">end</span><span class="x">]</span><span class="o">.</span><span class="n">x</span><span class="x">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">xmin</span><span class="x">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">xmax</span><span class="x">)</span>
    <span class="n">y_first</span> <span class="o">=</span> <span class="n">scale_coord</span><span class="x">(</span><span class="n">measurements</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span><span class="o">.</span><span class="n">y</span><span class="x">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">ymin</span><span class="x">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">ymax</span><span class="x">)</span>
    <span class="n">y_last</span> <span class="o">=</span> <span class="n">scale_coord</span><span class="x">(</span><span class="n">measurements</span><span class="x">[</span><span class="k">end</span><span class="x">]</span><span class="o">.</span><span class="n">y</span><span class="x">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">ymin</span><span class="x">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">ymax</span><span class="x">)</span>
    
    <span class="c"># sample dest_x</span>
    <span class="n">x_bounds</span> <span class="o">=</span> <span class="n">collect</span><span class="x">(</span><span class="n">range</span><span class="x">(</span><span class="n">scene</span><span class="o">.</span><span class="n">xmin</span><span class="x">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">scene</span><span class="o">.</span><span class="n">xmax</span><span class="x">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_x_bins</span><span class="o">+</span><span class="mi">1</span><span class="x">))</span>
    <span class="n">x_probs</span> <span class="o">~</span> <span class="n">x_nn</span><span class="x">([</span><span class="n">x_first</span><span class="x">,</span> <span class="n">y_first</span><span class="x">,</span> <span class="n">x_last</span><span class="x">,</span> <span class="n">y_last</span><span class="x">])</span>
    <span class="n">dest_x</span> <span class="o">~</span> <span class="n">piecewise_uniform</span><span class="x">(</span><span class="n">x_bounds</span><span class="x">,</span> <span class="n">softmax</span><span class="x">(</span><span class="n">x_probs</span><span class="x">))</span>
    
    <span class="c"># sample dest_y</span>
    <span class="n">y_bounds</span> <span class="o">=</span> <span class="n">collect</span><span class="x">(</span><span class="n">range</span><span class="x">(</span><span class="n">scene</span><span class="o">.</span><span class="n">ymin</span><span class="x">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">scene</span><span class="o">.</span><span class="n">ymax</span><span class="x">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_y_bins</span><span class="o">+</span><span class="mi">1</span><span class="x">))</span>
    <span class="n">y_probs</span> <span class="o">~</span> <span class="n">y_nn</span><span class="x">([</span><span class="n">x_first</span><span class="x">,</span> <span class="n">y_first</span><span class="x">,</span> <span class="n">x_last</span><span class="x">,</span> <span class="n">y_last</span><span class="x">,</span> <span class="n">dest_x</span><span class="x">])</span>
    
    <span class="n">dest_y</span> <span class="o">~</span> <span class="n">piecewise_uniform</span><span class="x">(</span><span class="n">y_bounds</span><span class="x">,</span> <span class="n">softmax</span><span class="x">(</span><span class="n">y_probs</span><span class="x">))</span>
    
    <span class="k">return</span> <span class="n">nothing</span>
<span class="k">end</span><span class="x">;</span>
</code></pre></div></div>

<p>To train the proposal, we construct an update that applies a fixed step size gradient descent move. We indicate that we want the update to apply to all the trainable parameters of <code class="highlighter-rouge">x_nn</code> and all the trainable parameters of <code class="highlighter-rouge">y_nn</code>. Note that <code class="highlighter-rouge">custom_dest_proposal_torch</code> does not have any trainable parameters of its own, unlike <code class="highlighter-rouge">custom_dest_proposal_neural</code>.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">update</span> <span class="o">=</span> <span class="n">Gen</span><span class="o">.</span><span class="n">ParamUpdate</span><span class="x">(</span><span class="n">Gen</span><span class="o">.</span><span class="n">ADAM</span><span class="x">(</span><span class="mf">0.001</span><span class="x">,</span> <span class="mf">0.9</span><span class="x">,</span> <span class="mf">0.999</span><span class="x">,</span> <span class="mf">1e-8</span><span class="x">),</span> 
    <span class="n">x_nn</span> <span class="o">=&gt;</span> <span class="n">collect</span><span class="x">(</span><span class="n">get_params</span><span class="x">(</span><span class="n">x_nn</span><span class="x">)),</span> <span class="n">y_nn</span> <span class="o">=&gt;</span> <span class="n">collect</span><span class="x">(</span><span class="n">get_params</span><span class="x">(</span><span class="n">y_nn</span><span class="x">)));</span>
</code></pre></div></div>

<p>And run the training procedure. Here, we’ve used the more effective ADAM
optimizer, so we can get by with less training. (But more training
may still help, and you may decide to run it for more epochs or larger epochs!
If you have a GPU available, GenPyTorch should automatically use it.)</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="nf"> data_generator</span><span class="x">()</span>
    
    <span class="c"># since these names are used in the global scope, explicitly declare it</span>
    <span class="c"># local to avoid overwriting the global variable</span>
    <span class="kd">local</span> <span class="n">measurements</span>
    <span class="kd">local</span> <span class="n">choices</span>
    
    <span class="c"># obtain an execution of the model where planning succeeded</span>
    <span class="n">done</span> <span class="o">=</span> <span class="n">false</span>
    <span class="k">while</span> <span class="o">!</span><span class="n">done</span>
        <span class="x">(</span><span class="n">choices</span><span class="x">,</span> <span class="n">_</span><span class="x">,</span> <span class="n">retval</span><span class="x">)</span> <span class="o">=</span> <span class="n">Gen</span><span class="o">.</span><span class="n">propose</span><span class="x">(</span><span class="n">agent_model</span><span class="x">,</span> <span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">dt</span><span class="x">,</span> <span class="n">num_ticks</span><span class="x">,</span> <span class="n">planner_params</span><span class="x">))</span>
        <span class="x">(</span><span class="n">planning_failed</span><span class="x">,</span> <span class="n">maybe_path</span><span class="x">)</span> <span class="o">=</span> <span class="n">retval</span>       
        <span class="n">done</span> <span class="o">=</span> <span class="o">!</span><span class="n">planning_failed</span>
    <span class="k">end</span>

    <span class="c"># construct arguments to the proposal function being trained</span>
    <span class="n">measurements</span> <span class="o">=</span> <span class="x">[</span><span class="n">Point</span><span class="x">(</span><span class="n">choices</span><span class="x">[:</span><span class="n">meas</span> <span class="o">=&gt;</span> <span class="x">(</span><span class="n">i</span><span class="x">,</span> <span class="x">:</span><span class="n">x</span><span class="x">)],</span> <span class="n">choices</span><span class="x">[:</span><span class="n">meas</span> <span class="o">=&gt;</span> <span class="x">(</span><span class="n">i</span><span class="x">,</span> <span class="x">:</span><span class="n">y</span><span class="x">)])</span> <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="x">:</span><span class="n">num_ticks</span><span class="x">]</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="x">(</span><span class="n">measurements</span><span class="x">,</span> <span class="n">scene</span><span class="x">)</span>
    
    <span class="c"># construct constraints for the proposal function being trained</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">Gen</span><span class="o">.</span><span class="n">choicemap</span><span class="x">()</span>
    <span class="n">constraints</span><span class="x">[:</span><span class="n">dest_x</span><span class="x">]</span> <span class="o">=</span> <span class="n">choices</span><span class="x">[:</span><span class="n">dest_x</span><span class="x">]</span>
    <span class="n">constraints</span><span class="x">[:</span><span class="n">dest_y</span><span class="x">]</span> <span class="o">=</span> <span class="n">choices</span><span class="x">[:</span><span class="n">dest_y</span><span class="x">]</span>
    
    <span class="k">return</span> <span class="x">(</span><span class="n">inputs</span><span class="x">,</span> <span class="n">constraints</span><span class="x">)</span>
<span class="k">end</span><span class="x">;</span>
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Gen</span><span class="o">.</span><span class="n">train!</span><span class="x">(</span><span class="n">custom_dest_proposal_torch</span><span class="x">,</span> <span class="n">data_generator</span><span class="x">,</span> <span class="n">update</span><span class="x">,</span>
    <span class="n">num_epoch</span><span class="o">=</span><span class="mi">10</span><span class="x">,</span> <span class="n">epoch_size</span><span class="o">=</span><span class="mi">100</span><span class="x">,</span> <span class="n">num_minibatch</span><span class="o">=</span><span class="mi">100</span><span class="x">,</span> <span class="n">minibatch_size</span><span class="o">=</span><span class="mi">100</span><span class="x">,</span>
    <span class="n">evaluation_size</span><span class="o">=</span><span class="mi">10</span><span class="x">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">true</span><span class="x">);</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>epoch 1: generating 100 training examples...
epoch 1: training using 100 minibatches of size 100...
epoch 1: evaluating on 10 examples...
epoch 1: est. objective value: 0.30674785750200567
epoch 2: generating 100 training examples...
epoch 2: training using 100 minibatches of size 100...
epoch 2: evaluating on 10 examples...
epoch 2: est. objective value: 0.057911306335681687
epoch 3: generating 100 training examples...
epoch 3: training using 100 minibatches of size 100...
epoch 3: evaluating on 10 examples...
epoch 3: est. objective value: 1.195958290383073
epoch 4: generating 100 training examples...
epoch 4: training using 100 minibatches of size 100...
epoch 4: evaluating on 10 examples...
epoch 4: est. objective value: 0.36682692005589856
epoch 5: generating 100 training examples...
epoch 5: training using 100 minibatches of size 100...
epoch 5: evaluating on 10 examples...
epoch 5: est. objective value: 0.8955448017601333
epoch 6: generating 100 training examples...
epoch 6: training using 100 minibatches of size 100...
epoch 6: evaluating on 10 examples...
epoch 6: est. objective value: 1.0538069887694372
epoch 7: generating 100 training examples...
epoch 7: training using 100 minibatches of size 100...
epoch 7: evaluating on 10 examples...
epoch 7: est. objective value: 0.9263616359863105
epoch 8: generating 100 training examples...
epoch 8: training using 100 minibatches of size 100...
epoch 8: evaluating on 10 examples...
epoch 8: est. objective value: 1.1320598453574786
epoch 9: generating 100 training examples...
epoch 9: training using 100 minibatches of size 100...
epoch 9: evaluating on 10 examples...
epoch 9: est. objective value: 0.3309016351778859
epoch 10: generating 100 training examples...
epoch 10: training using 100 minibatches of size 100...
epoch 10: evaluating on 10 examples...
epoch 10: est. objective value: 0.6199856166120441
</code></pre></div></div>

<p>We can visualize the proposal and see that although it’s not perfect, it correctly
focuses on the upper left regions of the scene.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="nf"> visualize_custom_destination_proposal</span><span class="x">(</span><span class="n">measurements</span><span class="x">,</span> <span class="n">start</span><span class="x">,</span> <span class="n">dest_proposal</span><span class="x">;</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">100</span><span class="x">)</span>
    <span class="n">visualize</span><span class="x">()</span> <span class="n">do</span> 
        <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="x">:</span><span class="n">num_samples</span>
            <span class="x">(</span><span class="n">proposed_choices</span><span class="x">,</span> <span class="n">_</span><span class="x">)</span> <span class="o">=</span> <span class="n">Gen</span><span class="o">.</span><span class="n">propose</span><span class="x">(</span><span class="n">dest_proposal</span><span class="x">,</span> <span class="x">(</span><span class="n">measurements</span><span class="x">,</span> <span class="n">scene</span><span class="x">))</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="n">choicemap</span><span class="x">(</span><span class="n">proposed_choices</span><span class="x">)</span>
            <span class="n">constraints</span><span class="x">[:</span><span class="n">start_x</span><span class="x">]</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">x</span>
            <span class="n">constraints</span><span class="x">[:</span><span class="n">start_y</span><span class="x">]</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">y</span>
            <span class="x">(</span><span class="n">trace</span><span class="x">,</span> <span class="n">_</span><span class="x">)</span> <span class="o">=</span> <span class="n">Gen</span><span class="o">.</span><span class="n">generate</span><span class="x">(</span><span class="n">agent_model</span><span class="x">,</span> <span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">dt</span><span class="x">,</span> <span class="n">num_ticks</span><span class="x">,</span> <span class="n">planner_params</span><span class="x">),</span> <span class="n">constraints</span><span class="x">)</span>
            <span class="n">draw_dest</span><span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">Point</span><span class="x">(</span><span class="n">trace</span><span class="x">[:</span><span class="n">dest_x</span><span class="x">],</span> <span class="n">trace</span><span class="x">[:</span><span class="n">dest_y</span><span class="x">]))</span>
        <span class="k">end</span>
        <span class="n">draw_scene</span><span class="x">(</span><span class="n">scene</span><span class="x">)</span>
        <span class="n">draw_start</span><span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">start</span><span class="x">)</span>
        <span class="n">draw_measurements</span><span class="x">(</span><span class="n">scene</span><span class="x">,</span> <span class="n">measurements</span><span class="x">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="x">;</span>
<span class="n">visualize_custom_destination_proposal</span><span class="x">(</span><span class="n">measurements</span><span class="x">,</span> <span class="n">start</span><span class="x">,</span> <span class="n">custom_dest_proposal_torch</span><span class="x">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="x">)</span>
</code></pre></div></div>

<p><img src="output_26_0.png" alt="png" /></p>

<h3 id="exercise">Exercise</h3>

<p>Give brief answers for the following questions:</p>

<ol>
  <li>Do you expect that the neural proposal trained above would work all right for <em>observed agent locations</em> different from the ones we’ve been working with in this notebook? Why or why not?</li>
  <li>Do you expect that the neural proposal trained above would work all right for <em>scenes</em> different from the one we’ve been working with in this notebook? Why or why not? (For example, would it do well in the <code class="highlighter-rouge">scene_2doors</code> scene from Problem 2.4? If so, can you imagine other scenes where it would fail?)</li>
  <li>If you answered “no” to either of the above questions, can you describe (but not implement!) a modification to the neural network architecture, the training procedure, or both that would allow you to answer “yes”?</li>
</ol>

<hr />
<h3 id="exercise-1">Exercise</h3>

<p>The training procedure for the neural networks above was not vectorized across training examples. For fast training on a GPU it is important to vectorize the evaluation of gradients across multiple training examples. Write a vectorized version of the <code class="highlighter-rouge">custom_dest_proposal_torch</code> that takes a scene and a vector of data sets (measurement vectors), and samples a destination point for each of the input data sets. Train it and visualize the proposal distribution, and the results of importance resampling inference that using the proposal for some amount of computation, for our example data set.</p>

<p>Hint:</p>

<ul>
  <li>
    <p>Construct a vectorized version of each of the neural networks that operate
on an extra ‘training example’ dimension.</p>
  </li>
  <li>
    <p>Construct a vectorized version of the proposal. It should accept a vector
of measurement vectors as one of its arguments. This vectorized propsal
should make 2N random choices where N is the batch size.</p>
  </li>
  <li>
    <p>Construct a vectorized version of the data generator. It should generate
constraints for all random choices of the vectorized proposal.</p>
  </li>
  <li>
    <p>Construct a non-vectorized version of the proposal that invokes the
vectorized neural networks on a single data set.</p>
  </li>
</ul>

</div>

</main><!-- /.container -->

<!-- Footer -->
<footer class="page-footer font-small blue pt-4">

  <!-- Copyright -->
  <div class="footer-copyright text-center py-3">© 2020 Copyright: The author(s).
  </div>
  <!-- Copyright -->

</footer>
<!-- Footer -->

<script
			  src="https://code.jquery.com/jquery-3.5.1.min.js"
			  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			  crossorigin="anonymous"></script>
    <!--<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  </body>
</html>
